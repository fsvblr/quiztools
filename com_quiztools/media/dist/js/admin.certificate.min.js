(function(){let o=null;document.querySelector("#jform_upload_image").addEventListener("change",function(){document.querySelector("#certificate-form-task").value="certificate.uploadImage",document.querySelector("#certificate-form").submit()}),document.querySelector("#jform_file").addEventListener("change",function(e){s(e.target.value,!1)}),document.addEventListener("DOMContentLoaded",function(){let e=document.querySelector("#jform_file").value;if(e){let t=document.querySelector(".subform-fields > .control-group");t.style.display="block",s(e,!0)}});function s(e,t){if(!t){let a=document.querySelectorAll(".subform-fields .group-remove");a.length>0&&a.forEach(r=>{r.click()})}const l=document.querySelector("#certificate-canvas-wrap");l.innerHTML="";let c=document.querySelector(".subform-fields > .control-group");if(c.style.display="none",o&&(o=null),e==="")return!1;const u=getComputedStyle(l),d=parseFloat(u.width)*.96,n=document.createElement("canvas");n.id="certificate-canvas",n.width=d,n.height="600",l.appendChild(n);let i=new Image;i.src="/images/quiztools/certificates/"+e,i.onload=()=>{c.style.display="block";let a=i.width<d?i.width:d;o=new fabric.Canvas(n,{originX:"left",originY:"top",width:a,height:i.height/i.width*a,backgroundImage:new fabric.Image(i)}),o.backgroundImage.scaleToWidth(a),o.backgroundImage.scaleToHeight(i.height/i.width*a),o.renderAll(),o.on("mouse:up",r=>{r.target&&r.target.hasOwnProperty("text")&&r.target.hasOwnProperty("id")&&g(r.target)}),o.on("text:changed",r=>{r.target&&r.target.hasOwnProperty("text")&&r.target.hasOwnProperty("id")&&g(r.target)}),t&&_()}}document.addEventListener("subform-row-add",({detail:{row:e}})=>{m(e)});function m(e){let t=e.dataset.group.replace(/[^0-9]/g,""),l=e.querySelector("#jform_fields__fields"+t+"__text"),c=e.querySelector("#jform_fields__fields"+t+"__x"),u=e.querySelector("#jform_fields__fields"+t+"__y"),d=e.querySelector("#jform_fields__fields"+t+"__font_family"),n=e.querySelector("#jform_fields__fields"+t+"__font_size"),i=e.querySelector("#jform_fields__fields"+t+"__color"),a=Math.round(n.value*1.328147),r=new fabric.IText(l.value,{left:parseInt(c.value),top:parseInt(u.value),originY:"center",fontFamily:d.value,fontSize:a,fill:i.value,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,cornerSize:1,id:"canvasText_"+t});r.controls.mtr.visible=!1,o.add(r),d.addEventListener("input",function(f){r.set("fontFamily",f.target.value),o.renderAll()}),n.addEventListener("input",function(f){let p=Math.round(f.target.value*1.328147);r.set("fontSize",p),o.renderAll()}),i.addEventListener("selectionchange",function(f){r.set("fill",f.target.value),o.renderAll()})}document.addEventListener("subform-row-remove",({detail:{row:e}})=>{let t=e.dataset.group.replace(/[^0-9]/g,"");o.forEachObject(l=>{if(l.id&&l.id==="canvasText_"+t){o.setActiveObject(l);let c=o.getActiveObject();o.remove(c)}})});function g(e){let t=e.id.replace(/[^0-9]/g,""),l=document.querySelector('.subform-fields tr.subform-repeatable-group[data-group="fields'+t+'"]');l&&(l.querySelector("#jform_fields__fields"+t+"__text").value=e.text,l.querySelector("#jform_fields__fields"+t+"__x").value=e.left,l.querySelector("#jform_fields__fields"+t+"__y").value=e.top)}function _(){let e=document.querySelectorAll(".subform-fields .subform-repeatable-group");e.length>0&&e.forEach(t=>{m(t)})}})();
